<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Download Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .test-container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .resume-layout {
      display: table;
      width: 100%;
      border-collapse: collapse;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      background: white;
    }

    .resume-layout tbody tr {
      display: table-row;
    }

    .left-column, .right-column {
      display: table-cell;
      vertical-align: top;
      padding: 20px;
    }

    .left-column {
      width: 35%;
      background-color: #f8f9fa;
      border-right: 2px solid #007bff;
    }

    .right-column {
      width: 65%;
      background-color: white;
    }

    .resume-layout h1 {
      color: #007bff;
      font-size: 2.5em;
      margin: 0 0 10px 0;
      font-weight: bold;
    }

    .resume-layout h2 {
      color: #007bff;
      font-size: 1.3em;
      margin: 25px 0 15px 0;
      font-weight: bold;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }

    .resume-layout h3 {
      color: #333;
      font-size: 1.1em;
      margin: 20px 0 8px 0;
      font-weight: bold;
    }

    .resume-layout p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .resume-layout ul {
      margin: 10px 0 20px 20px;
      padding: 0;
    }

    .resume-layout li {
      margin: 5px 0;
      line-height: 1.5;
    }

    .test-buttons {
      margin: 20px 0;
      text-align: center;
    }

    .test-btn {
      background: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
      font-size: 16px;
    }

    .test-btn:hover {
      background: #0056b3;
    }

    .test-results {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }

    .status {
      padding: 5px 10px;
      border-radius: 3px;
      margin: 5px 0;
    }

    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Resume Download Testing Lab</h1>
    <p>This page tests the actual download functionality using the same sample data and styling as the main application.</p>
    
    <div class="test-buttons">
      <button class="test-btn" onclick="testPdfDownload()">üìÑ Test PDF Download</button>
      <button class="test-btn" onclick="testWordDownload()">üìù Test Word Download</button>
      <button class="test-btn" onclick="validateContent()">‚úÖ Validate Content</button>
    </div>

    <div id="results" class="test-results" style="display:none;">
      <h3>Test Results:</h3>
      <div id="status-log"></div>
    </div>

    <div class="test-container">
      <h2>üìã Sample Resume (This is what gets downloaded)</h2>
      <div id="resumePreview">
        <table class="resume-layout">
          <tbody>
            <tr>
              <td class="left-column">
                <h2>Skills</h2>
                <p><strong>Technical Skills:</strong> JavaScript (ES6+), TypeScript, React, Node.js, HTML5, CSS3, SQL, NoSQL, AWS</p>
                <p><strong>Soft Skills:</strong> Agile Methodologies, Problem Solving, Team Collaboration, Communication</p>
                
                <h2>Education</h2>
                <div>
                  <h3>B.S. in Computer Science</h3>
                  <p><strong>State University</strong></p>
                  <p>Anytown, USA</p>
                  <p>Graduated May 2020</p>
                </div>
              </td>
              <td class="right-column">
                <h1>Jane Doe</h1>
                <p>555-555-5555 | jane.doe@email.com | linkedin.com/in/janedoe</p>

                <h2>Summary</h2>
                <p>Results-driven Software Engineer with 4+ years of experience in developing, testing, and maintaining web applications. Proficient in JavaScript, React, and Node.js, with a passion for creating intuitive user experiences.</p>

                <h2>Experience</h2>
                <div>
                  <h3>Software Engineer</h3>
                  <p><strong>Tech Solutions Inc.</strong> | Anytown, USA | June 2020 ‚Äì Present</p>
                  <ul>
                    <li>Developed and maintained client-side applications using React, resulting in a 20% increase in user engagement.</li>
                    <li>Collaborated with a team of 5 engineers to build and deploy new features on a weekly basis.</li>
                    <li>Wrote unit and integration tests to ensure code quality and maintainability.</li>
                  </ul>
                </div>
                <div>
                  <h3>Software Engineer Intern</h3>
                  <p><strong>Innovate Corp.</strong> | Anytown, USA | May 2019 ‚Äì August 2019</p>
                  <ul>
                    <li>Assisted in the development of a new REST API using Node.js and Express.</li>
                    <li>Participated in code reviews and agile ceremonies.</li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Load required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-docx@1.8.0/dist/html-to-docx.umd.js"></script>

  <script>
    function logStatus(message, type = 'info') {
      const results = document.getElementById('results');
      const statusLog = document.getElementById('status-log');
      
      results.style.display = 'block';
      
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
      statusLog.appendChild(statusDiv);
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    async function testPdfDownload() {
      try {
        logStatus('üîÑ Starting PDF download test...', 'warning');
        
        // Check if html2pdf is loaded
        if (typeof html2pdf === 'undefined') {
          throw new Error('html2pdf library not loaded');
        }
        
        logStatus('‚úÖ html2pdf library loaded', 'success');
        
        // Get the resume content
        const resumeElement = document.getElementById('resumePreview');
        if (!resumeElement) {
          throw new Error('Resume preview element not found');
        }
        
        logStatus('‚úÖ Resume content found', 'success');
        
        // Create iframe for proper PDF rendering (same as production code)
        const iframe = document.createElement('iframe');
        iframe.style.position = 'absolute';
        iframe.style.left = '-9999px';
        iframe.style.width = '210mm';
        iframe.style.height = '297mm';
        document.body.appendChild(iframe);
        
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        // Create complete HTML document with styles
        const fullHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              ${document.querySelector('style').innerHTML}
              
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: Arial, sans-serif; 
                background: white;
              }
            </style>
          </head>
          <body>
            ${resumeElement.innerHTML}
          </body>
          </html>
        `;
        
        iframeDoc.open();
        iframeDoc.write(fullHtml);
        iframeDoc.close();
        
        logStatus('‚úÖ Iframe created with complete HTML document', 'success');
        
        // Wait for content to load
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Generate PDF
        const element = iframeDoc.body;
        const options = {
          margin: [0.5, 0.5, 0.5, 0.5],
          filename: 'test-resume.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true,
            letterRendering: true
          },
          jsPDF: { 
            unit: 'in', 
            format: 'letter', 
            orientation: 'portrait' 
          }
        };
        
        logStatus('üîÑ Generating PDF...', 'warning');
        
        await html2pdf().set(options).from(element).save();
        
        logStatus('üéâ PDF download completed successfully!', 'success');
        
        // Cleanup
        document.body.removeChild(iframe);
        
      } catch (error) {
        logStatus(`‚ùå PDF test failed: ${error.message}`, 'error');
        console.error('PDF Error:', error);
      }
    }

    async function testWordDownload() {
      try {
        logStatus('üîÑ Starting Word download test...', 'warning');
        
        // Check if HTMLtoDOCX is loaded
        if (typeof HTMLtoDOCX === 'undefined') {
          throw new Error('HTMLtoDOCX library not loaded');
        }
        
        logStatus('‚úÖ HTMLtoDOCX library loaded', 'success');
        
        // Get resume content and convert table to divs
        const resumeElement = document.getElementById('resumePreview');
        let cleanHtml = resumeElement.innerHTML;
        
        // Convert table structure to div structure for Word compatibility
        cleanHtml = cleanHtml
          .replace(/<table[^>]*class="resume-layout"[^>]*>/g, '<div class="resume-layout">')
          .replace(/<\/table>/g, '</div>')
          .replace(/<tbody[^>]*>/g, '')
          .replace(/<\/tbody>/g, '')
          .replace(/<tr[^>]*>/g, '<div class="resume-row">')
          .replace(/<\/tr>/g, '</div>')
          .replace(/<td[^>]*class="left-column"[^>]*>/g, '<div class="left-section">')
          .replace(/<td[^>]*class="right-column"[^>]*>/g, '<div class="right-section">')
          .replace(/<\/td>/g, '</div>');
        
        logStatus('‚úÖ HTML structure converted for Word compatibility', 'success');
        
        // Create CSS for Word document
        const css = `
          .resume-layout { 
            display: flex; 
            width: 100%; 
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
          }
          .left-section { 
            flex: 35%; 
            padding: 20px; 
            background-color: #f8f9fa;
            border-right: 2px solid #007bff;
          }
          .right-section { 
            flex: 65%; 
            padding: 20px; 
            background-color: white;
          }
          h1 { 
            color: #007bff; 
            font-size: 2.5em; 
            margin: 0 0 10px 0; 
            font-weight: bold; 
          }
          h2 { 
            color: #007bff; 
            font-size: 1.3em; 
            margin: 25px 0 15px 0; 
            font-weight: bold; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 5px; 
          }
          h3 { 
            color: #333; 
            font-size: 1.1em; 
            margin: 20px 0 8px 0; 
            font-weight: bold; 
          }
          p { 
            margin: 10px 0; 
            line-height: 1.6; 
          }
          ul { 
            margin: 10px 0 20px 20px; 
            padding: 0; 
          }
          li { 
            margin: 5px 0; 
            line-height: 1.5; 
          }
        `;
        
        // Generate DOCX
        logStatus('üîÑ Generating Word document...', 'warning');
        
        const docxBlob = await HTMLtoDOCX(cleanHtml, null, {
          table: { row: { cantSplit: true } },
          footer: true,
          pageNumber: true,
          font: 'Arial',
          fontSize: 22,
          complexScriptFont: 'Arial',
          css: css
        });
        
        if (!docxBlob) {
          throw new Error('Failed to generate DOCX blob');
        }
        
        logStatus('‚úÖ Word document generated successfully', 'success');
        
        // Download the file
        const link = document.createElement('a');
        link.href = URL.createObjectURL(docxBlob);
        link.download = 'test-resume.docx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        logStatus('üéâ Word download completed successfully!', 'success');
        
      } catch (error) {
        logStatus(`‚ùå Word test failed: ${error.message}`, 'error');
        console.error('Word Error:', error);
        
        // Fallback to RTF
        try {
          logStatus('üîÑ Attempting RTF fallback...', 'warning');
          
          const resumeElement = document.getElementById('resumePreview');
          const rtfContent = convertHtmlToRtf(resumeElement.innerHTML);
          
          const rtfBlob = new Blob([rtfContent], { type: 'application/rtf' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(rtfBlob);
          link.download = 'test-resume.rtf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          logStatus('‚úÖ RTF fallback download completed!', 'success');
          
        } catch (rtfError) {
          logStatus(`‚ùå RTF fallback also failed: ${rtfError.message}`, 'error');
        }
      }
    }

    function convertHtmlToRtf(html) {
      let rtfContent = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}\\f0\\fs24 ';
      
      // Remove table structure and convert to RTF
      const cleanText = html
        .replace(/<table[^>]*>/g, '')
        .replace(/<\/table>/g, '')
        .replace(/<tbody[^>]*>/g, '')
        .replace(/<\/tbody>/g, '')
        .replace(/<tr[^>]*>/g, '')
        .replace(/<\/tr>/g, '')
        .replace(/<td[^>]*>/g, '')
        .replace(/<\/td>/g, '\\par ')
        .replace(/<h1[^>]*>/g, '\\b\\fs36 ')
        .replace(/<\/h1>/g, '\\b0\\fs24\\par\\par ')
        .replace(/<h2[^>]*>/g, '\\b\\fs28 ')
        .replace(/<\/h2>/g, '\\b0\\fs24\\par ')
        .replace(/<h3[^>]*>/g, '\\b\\fs24 ')
        .replace(/<\/h3>/g, '\\b0\\fs24\\par ')
        .replace(/<p[^>]*>/g, '')
        .replace(/<\/p>/g, '\\par ')
        .replace(/<div[^>]*>/g, '')
        .replace(/<\/div>/g, '\\par ')
        .replace(/<li[^>]*>/g, '\\bullet ')
        .replace(/<\/li>/g, '\\par ')
        .replace(/<ul[^>]*>/g, '')
        .replace(/<\/ul>/g, '\\par ')
        .replace(/<strong[^>]*>/g, '\\b ')
        .replace(/<\/strong>/g, '\\b0 ')
        .replace(/<[^>]*>/g, '')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/\s+/g, ' ')
        .trim();
      
      rtfContent += cleanText + '}';
      return rtfContent;
    }

    function validateContent() {
      logStatus('üîÑ Validating content completeness...', 'warning');
      
      const resumeElement = document.getElementById('resumePreview');
      const content = resumeElement.textContent || resumeElement.innerText;
      
      // Check for key content
      const checks = [
        { item: 'Name', found: content.includes('Jane Doe') },
        { item: 'Email', found: content.includes('jane.doe@email.com') },
        { item: 'Skills section', found: content.includes('Technical Skills') },
        { item: 'Experience section', found: content.includes('Software Engineer') },
        { item: 'Education section', found: content.includes('B.S. in Computer Science') },
        { item: 'Company names', found: content.includes('Tech Solutions Inc.') },
        { item: 'Job responsibilities', found: content.includes('React') }
      ];
      
      let passedChecks = 0;
      checks.forEach(check => {
        if (check.found) {
          logStatus(`‚úÖ ${check.item}: Found`, 'success');
          passedChecks++;
        } else {
          logStatus(`‚ùå ${check.item}: Missing`, 'error');
        }
      });
      
      const percentage = Math.round((passedChecks / checks.length) * 100);
      logStatus(`üìä Content validation: ${passedChecks}/${checks.length} (${percentage}%) checks passed`, 
                percentage === 100 ? 'success' : 'warning');
      
      if (percentage === 100) {
        logStatus('üéâ All content validation checks passed! Resume is complete.', 'success');
      } else {
        logStatus('‚ö†Ô∏è Some content may be missing from downloads.', 'warning');
      }
    }

    // Auto-validate content on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        logStatus('üöÄ Page loaded. Ready for testing!', 'success');
        validateContent();
      }, 1000);
    });
  </script>
</body>
</html>